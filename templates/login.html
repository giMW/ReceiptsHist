<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ReceiptsHist - Login</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{--bg-gradient:linear-gradient(135deg,#667eea 0%,#764ba2 100%);--card:#fff;--text:#1a1a2e;--muted:#636e72;--border:#e0e0e0;--input-bg:#fafafa;--input-focus-bg:#fff}
[data-theme="dark"]{--bg-gradient:linear-gradient(135deg,#1a1a2e 0%,#2d2d4a 100%);--card:#252542;--text:#e4e4e7;--muted:#a1a1aa;--border:#3f3f5c;--input-bg:#1e1e36;--input-focus-bg:#252542}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg-gradient);display:flex;align-items:center;justify-content:center;min-height:100vh;color:var(--text);padding:20px}
.card{background:var(--card);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.2);padding:40px;width:100%;max-width:420px}
.logo{text-align:center;margin-bottom:8px}
.logo-icon{font-size:48px;margin-bottom:8px}
h1{text-align:center;margin-bottom:8px;font-size:28px;color:var(--text);font-weight:700}
.subtitle{text-align:center;color:var(--muted);margin-bottom:28px;font-size:14px}
.tabs{display:flex;margin-bottom:24px;background:var(--input-bg);border-radius:10px;padding:4px}
.tab{flex:1;text-align:center;padding:12px;cursor:pointer;font-weight:600;color:var(--muted);border-radius:8px;transition:.2s}
.tab.active{background:#6c5ce7;color:#fff;box-shadow:0 4px 12px rgba(108,92,231,.3)}
.tab:hover:not(.active){background:var(--border)}
.form-group{margin-bottom:18px;position:relative}
label{display:block;font-size:13px;font-weight:600;margin-bottom:6px;color:var(--text)}
input[type=email],input[type=password],input[type=text]{width:100%;padding:12px 14px;border:2px solid var(--border);border-radius:10px;font-size:15px;transition:.2s;background:var(--input-bg);color:var(--text)}
input:focus{outline:none;border-color:#6c5ce7;box-shadow:0 0 0 4px rgba(108,92,231,.1);background:var(--input-focus-bg)}
input.invalid{border-color:#e74c3c;background:#fef5f5}
input.valid{border-color:#27ae60;background:#f5fef7}
.password-wrapper{position:relative}
.password-wrapper input{padding-right:44px}
.toggle-password{position:absolute;right:12px;top:50%;transform:translateY(-50%);cursor:pointer;color:#a0a0a0;font-size:18px;user-select:none;transition:.2s}
.toggle-password:hover{color:#6c5ce7}
.remember-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;font-size:13px}
.remember-row label{display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:500;margin-bottom:0}
.remember-row input[type=checkbox]{width:18px;height:18px;accent-color:#6c5ce7;cursor:pointer}
button[type=submit]{width:100%;padding:14px;background:linear-gradient(135deg,#6c5ce7 0%,#a29bfe 100%);color:#fff;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;transition:.3s;box-shadow:0 4px 15px rgba(108,92,231,.3)}
button[type=submit]:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(108,92,231,.4)}
button[type=submit]:active{transform:translateY(0)}
button[type=submit]:disabled{background:#b8b8b8;cursor:not-allowed;transform:none;box-shadow:none}
.flash{padding:12px 16px;border-radius:10px;margin-bottom:18px;font-size:14px;display:flex;align-items:center;gap:10px}
.flash.error{background:#ffeaea;color:#c0392b;border:1px solid #f5c6cb}
.flash.success{background:#e8f8f5;color:#1e8449;border:1px solid #a9dfbf}
.flash.warning{background:#fef9e7;color:#9a7b0a;border:1px solid #f9e79f}
.hidden{display:none}

/* Password strength indicator */
.strength-meter{height:6px;background:var(--border);border-radius:3px;margin-top:8px;overflow:hidden}
.strength-bar{height:100%;width:0;border-radius:3px;transition:width .3s,background .3s}
.strength-bar.weak{width:25%;background:#e74c3c}
.strength-bar.fair{width:50%;background:#f39c12}
.strength-bar.good{width:75%;background:#3498db}
.strength-bar.strong{width:100%;background:#27ae60}
.strength-text{font-size:12px;margin-top:6px;color:var(--muted)}
.requirements{margin-top:10px;font-size:12px;color:var(--muted)}
.requirement{display:flex;align-items:center;gap:6px;margin-bottom:4px}
.requirement.met{color:#27ae60}
.requirement.unmet{color:#a0a0a0}
.requirement span{font-size:14px}

/* Rate limit warning */
.rate-limit-warning{background:#fff3cd;border:1px solid #ffc107;border-radius:10px;padding:12px 16px;margin-bottom:18px;font-size:13px;color:#856404;display:none}

/* Loading spinner */
.spinner{display:inline-block;width:18px;height:18px;border:2px solid #fff;border-radius:50%;border-top-color:transparent;animation:spin .8s linear infinite;margin-right:8px;vertical-align:middle}
@keyframes spin{to{transform:rotate(360deg)}}

/* Divider */
.divider{display:flex;align-items:center;margin:24px 0;color:var(--muted);font-size:13px}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--border)}
.divider span{padding:0 16px}

/* Google button */
.google-btn{width:100%;padding:12px;background:var(--card);color:var(--text);border:2px solid var(--border);border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;transition:.2s;display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:16px;text-decoration:none}
.google-btn:hover{background:var(--input-bg);border-color:var(--muted)}
.google-btn svg{width:20px;height:20px}

/* Theme toggle */
.theme-toggle{position:absolute;top:20px;right:20px;background:none;border:none;cursor:pointer;font-size:24px;opacity:0.7;transition:.2s}
.theme-toggle:hover{opacity:1}
</style>
</head>
<body>
<button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode">&#x1F319;</button>
<div class="card">
  <div class="logo">
    <div class="logo-icon">&#x1F9FE;</div>
  </div>
  <h1>ReceiptsHist</h1>
  <p class="subtitle">Track every item, know every price</p>

  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
  {% for category, msg in messages %}
  <div class="flash {{ category }}">{{ msg }}</div>
  {% endfor %}
  {% endif %}
  {% endwith %}

  <div id="rateLimitWarning" class="rate-limit-warning">
    Too many login attempts. Please wait <span id="countdown">30</span> seconds.
  </div>

  <div class="tabs">
    <div class="tab active" onclick="showForm('login')">Log In</div>
    <div class="tab" onclick="showForm('signup')">Sign Up</div>
  </div>

  {% if google_enabled %}
  <a href="/auth/google" class="google-btn">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
      <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
      <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
      <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
    </svg>
    Continue with Google
  </a>
  <div class="divider"><span>or</span></div>
  {% endif %}

  <form id="loginForm" action="/login" method="post" onsubmit="return handleSubmit(this, 'login')">
    <div class="form-group">
      <label>Email</label>
      <input type="email" name="email" required autocomplete="email" placeholder="you@example.com">
    </div>
    <div class="form-group">
      <label>Password</label>
      <div class="password-wrapper">
        <input type="password" name="password" required autocomplete="current-password" placeholder="Enter your password">
        <span class="toggle-password" onclick="togglePassword(this)">&#x1F441;</span>
      </div>
    </div>
    <div class="remember-row">
      <label>
        <input type="checkbox" name="remember" value="1" id="rememberSession">
        Stay logged in
      </label>
      <label>
        <input type="checkbox" id="rememberEmail" checked>
        Remember email
      </label>
    </div>
    <button type="submit" id="loginBtn">Log In</button>
  </form>

  <form id="signupForm" action="/signup" method="post" class="hidden" onsubmit="return handleSubmit(this, 'signup')">
    <div class="form-group">
      <label>Email</label>
      <input type="email" name="email" required autocomplete="email" placeholder="you@example.com" oninput="validateEmail(this)">
    </div>
    <div class="form-group">
      <label>Password</label>
      <div class="password-wrapper">
        <input type="password" name="password" id="signupPassword" required minlength="8" autocomplete="new-password" placeholder="Create a strong password" oninput="checkPasswordStrength(this.value)">
        <span class="toggle-password" onclick="togglePassword(this)">&#x1F441;</span>
      </div>
      <div class="strength-meter"><div class="strength-bar" id="strengthBar"></div></div>
      <div class="strength-text" id="strengthText"></div>
      <div class="requirements">
        <div class="requirement unmet" id="reqLength"><span>&#x2717;</span> At least 8 characters</div>
        <div class="requirement unmet" id="reqUpper"><span>&#x2717;</span> One uppercase letter</div>
        <div class="requirement unmet" id="reqLower"><span>&#x2717;</span> One lowercase letter</div>
        <div class="requirement unmet" id="reqNumber"><span>&#x2717;</span> One number</div>
        <div class="requirement unmet" id="reqSpecial"><span>&#x2717;</span> One special character (!@#$%^&*)</div>
      </div>
    </div>
    <button type="submit" id="signupBtn">Create Account</button>
  </form>
</div>

<script>
// Rate limiting (client-side tracking)
const RATE_LIMIT_KEY = 'loginAttempts';
const MAX_ATTEMPTS = 5;
const LOCKOUT_TIME = 30000; // 30 seconds

function getAttempts() {
  const data = JSON.parse(localStorage.getItem(RATE_LIMIT_KEY) || '{"count":0,"timestamp":0}');
  // Reset if lockout period passed
  if (Date.now() - data.timestamp > LOCKOUT_TIME) {
    data.count = 0;
  }
  return data;
}

function recordAttempt() {
  const data = getAttempts();
  data.count++;
  data.timestamp = Date.now();
  localStorage.setItem(RATE_LIMIT_KEY, JSON.stringify(data));
}

function clearAttempts() {
  localStorage.removeItem(RATE_LIMIT_KEY);
}

function isRateLimited() {
  const data = getAttempts();
  if (data.count >= MAX_ATTEMPTS && Date.now() - data.timestamp < LOCKOUT_TIME) {
    return Math.ceil((LOCKOUT_TIME - (Date.now() - data.timestamp)) / 1000);
  }
  return 0;
}

function showRateLimitWarning(seconds) {
  const warning = document.getElementById('rateLimitWarning');
  const countdown = document.getElementById('countdown');
  warning.style.display = 'block';
  countdown.textContent = seconds;

  const interval = setInterval(() => {
    seconds--;
    countdown.textContent = seconds;
    if (seconds <= 0) {
      clearInterval(interval);
      warning.style.display = 'none';
      clearAttempts();
    }
  }, 1000);
}

// Password visibility toggle
function togglePassword(el) {
  const input = el.previousElementSibling;
  if (input.type === 'password') {
    input.type = 'text';
    el.innerHTML = '&#x1F576;'; // sunglasses
  } else {
    input.type = 'password';
    el.innerHTML = '&#x1F441;'; // eye
  }
}

// Password strength checker
function checkPasswordStrength(password) {
  const bar = document.getElementById('strengthBar');
  const text = document.getElementById('strengthText');

  // Check individual requirements
  const checks = {
    length: password.length >= 8,
    upper: /[A-Z]/.test(password),
    lower: /[a-z]/.test(password),
    number: /[0-9]/.test(password),
    special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
  };

  // Update requirement indicators
  updateRequirement('reqLength', checks.length);
  updateRequirement('reqUpper', checks.upper);
  updateRequirement('reqLower', checks.lower);
  updateRequirement('reqNumber', checks.number);
  updateRequirement('reqSpecial', checks.special);

  // Calculate strength
  const score = Object.values(checks).filter(Boolean).length;

  bar.className = 'strength-bar';
  if (password.length === 0) {
    bar.style.width = '0';
    text.textContent = '';
  } else if (score <= 2) {
    bar.classList.add('weak');
    text.textContent = 'Weak - add more character types';
  } else if (score === 3) {
    bar.classList.add('fair');
    text.textContent = 'Fair - getting better';
  } else if (score === 4) {
    bar.classList.add('good');
    text.textContent = 'Good - almost there!';
  } else {
    bar.classList.add('strong');
    text.textContent = 'Strong - excellent password!';
  }

  return score >= 4; // Require at least 4 criteria for signup
}

function updateRequirement(id, met) {
  const el = document.getElementById(id);
  if (met) {
    el.classList.remove('unmet');
    el.classList.add('met');
    el.querySelector('span').innerHTML = '&#x2713;';
  } else {
    el.classList.remove('met');
    el.classList.add('unmet');
    el.querySelector('span').innerHTML = '&#x2717;';
  }
}

// Email validation visual feedback
function validateEmail(input) {
  const valid = input.validity.valid && input.value.includes('@') && input.value.includes('.');
  input.classList.toggle('valid', valid && input.value.length > 0);
  input.classList.toggle('invalid', !valid && input.value.length > 0);
}

// Form submission handler
function handleSubmit(form, type) {
  if (type === 'login') {
    const remaining = isRateLimited();
    if (remaining > 0) {
      showRateLimitWarning(remaining);
      return false;
    }
    recordAttempt();

    // Save email if remember email is checked
    const email = form.querySelector('input[name="email"]').value;
    saveEmail(email);
  }

  if (type === 'signup') {
    const password = document.getElementById('signupPassword').value;
    if (!checkPasswordStrength(password)) {
      alert('Please create a stronger password that meets all requirements.');
      return false;
    }
  }

  // Show loading state
  const btn = form.querySelector('button[type=submit]');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>' + (type === 'login' ? 'Logging in...' : 'Creating account...');

  return true;
}

// Tab switching
function showForm(which) {
  document.getElementById('loginForm').classList.toggle('hidden', which !== 'login');
  document.getElementById('signupForm').classList.toggle('hidden', which !== 'signup');
  document.querySelectorAll('.tab').forEach((t, i) => {
    t.classList.toggle('active', (which === 'login' && i === 0) || (which === 'signup' && i === 1));
  });
}

// Remember Email functionality
const REMEMBER_EMAIL_KEY = 'rememberedEmail';
const REMEMBER_EMAIL_PREF = 'rememberEmailPref';

function loadRememberedEmail() {
  const savedEmail = localStorage.getItem(REMEMBER_EMAIL_KEY);
  const rememberPref = localStorage.getItem(REMEMBER_EMAIL_PREF) !== 'false';

  document.getElementById('rememberEmail').checked = rememberPref;

  if (savedEmail && rememberPref) {
    const emailInput = document.querySelector('#loginForm input[name="email"]');
    emailInput.value = savedEmail;
    emailInput.classList.add('valid');
  }
}

function saveEmail(email) {
  if (document.getElementById('rememberEmail').checked) {
    localStorage.setItem(REMEMBER_EMAIL_KEY, email);
    localStorage.setItem(REMEMBER_EMAIL_PREF, 'true');
  } else {
    localStorage.removeItem(REMEMBER_EMAIL_KEY);
    localStorage.setItem(REMEMBER_EMAIL_PREF, 'false');
  }
}

// Theme toggle
function toggleTheme(){
  const html=document.documentElement;
  const current=html.getAttribute('data-theme');
  const next=current==='dark'?'light':'dark';
  html.setAttribute('data-theme',next);
  localStorage.setItem('theme',next);
  updateThemeIcon(next);
}
function updateThemeIcon(theme){
  document.querySelector('.theme-toggle').textContent=theme==='dark'?'â˜€ï¸':'ðŸŒ™';
}
function initTheme(){
  const saved=localStorage.getItem('theme');
  const prefersDark=window.matchMedia('(prefers-color-scheme:dark)').matches;
  const theme=saved||(prefersDark?'dark':'light');
  if(theme==='dark')document.documentElement.setAttribute('data-theme','dark');
  updateThemeIcon(theme);
}

// Check rate limit and load email on page load
window.onload = function() {
  initTheme();
  const remaining = isRateLimited();
  if (remaining > 0) {
    showRateLimitWarning(remaining);
  }
  loadRememberedEmail();
};
</script>
</body>
</html>
